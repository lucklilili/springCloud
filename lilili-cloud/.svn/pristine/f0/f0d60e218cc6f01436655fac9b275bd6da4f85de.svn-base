package com.bwcloud.finance.center.biz;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.TypeReference;
import com.bwcloud.finance.center.entity.*;
import com.bwcloud.finance.center.mapper.PjZzspFpmxzbMapper;
import com.bwcloud.finance.center.utils.InvoiceLoanUtil;
import com.github.wxiaoqi.security.common.constant.BwCloudConstants;
import com.github.wxiaoqi.security.common.util.StringHelper;
import com.github.wxiaoqi.security.common.util.UUIDUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.bwcloud.finance.center.mapper.PjZzspFpmxMapper;
import com.github.wxiaoqi.security.common.biz.BusinessBiz;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

/**
 * @author Dong.Zhen
 * @version 2018-04-02 14:21:14
 * @email 463540703@qq.com
 */
@Service
public class PjZzspFpmxBiz extends BusinessBiz<PjZzspFpmxMapper, PjZzspFpmx> {

    @Autowired
    PjZzspFpmxMapper pjZzspFpmxMapper;

    @Autowired
    PjZzspFpmxzbMapper pjZzspFpmxzbMapper;

    public void insertInvoice(Map invoiceMaps) {
        Map invoiceMap = (Map) invoiceMaps.get("group");
        invoiceMap.put("fplxdm", BwCloudConstants.ZZS_PT_FP);
        String fpdm = (String) invoiceMap.get("fpdm");
        String fphm = (String) invoiceMap.get("fphm");
        PjZzspFpmx pjZzspFpmx = pjZzspFpmxMapper.queryInvoiceInfo(fpdm, fphm);
        if (StringHelper.isEmpty(pjZzspFpmx)) {
            pjZzspFpmx = JSON.parseObject(JSON.toJSONString(invoiceMap), new TypeReference<PjZzspFpmx>() {
            });
            String id = UUIDUtils.generateUuid();
            pjZzspFpmx.setId(id);
            Object obj;
            if ("1".equals(pjZzspFpmx.getQdbz())) {
                obj = ((Map) invoiceMap.get("qdxm")).get("group");
            } else {
                obj = ((Map) invoiceMap.get("fyxm")).get("group");
            }
            List<Map> invoiceDetailList = new ArrayList<>();
            if (obj instanceof Map) {
                invoiceDetailList.add((Map) obj);
            } else {
                invoiceDetailList.addAll((List<Map>) obj);
            }
            List<PjZzspFpmxzb> pjZzspFpmxzbList = new ArrayList<>();
            for (int i = 0; i < invoiceDetailList.size(); i++) {
                Map invoiceDetailMap = invoiceDetailList.get(i);
                PjZzspFpmxzb pjZzspFpmxzb = JSON.parseObject(JSON.toJSONString(invoiceDetailMap), new TypeReference<PjZzspFpmxzb>() {
                });
                pjZzspFpmxzb.setId(UUIDUtils.generateUuid());
                pjZzspFpmxzb.setMxid(id);
                pjZzspFpmxzb.setFphm(pjZzspFpmx.getFphm());
                pjZzspFpmxzb.setFpdm(pjZzspFpmx.getFpdm());
                pjZzspFpmxzb.setJqbh(pjZzspFpmx.getJqbh());
                pjZzspFpmxzb.setFpmxxh(i + 1);
                pjZzspFpmxzb.setKprq(pjZzspFpmx.getKprq());
                pjZzspFpmxzbList.add(pjZzspFpmxzb);
            }
            pjZzspFpmxMapper.insert(pjZzspFpmx);
            pjZzspFpmxzbMapper.insertInvoiceDetailList(pjZzspFpmxzbList);
        }
    }

    public List<PjZzspFpmx> queryInvoiceList(ArrayList<TaxDataUploadTranInfo> taxDataUploadTranInfos, String nsrsbh, String start_date, String sksbbh) {
        List<PjZzspFpmx> pjZzspFpmxList = pjZzspFpmxMapper.queryInvoiceList(nsrsbh, start_date, sksbbh);
        if (pjZzspFpmxList.size() > 0) {
            for (PjZzspFpmx pjZzspFpmx : pjZzspFpmxList) {
                TaxDataUploadTranInfo taxDataUploadTranInfo = new TaxDataUploadTranInfo();
                taxDataUploadTranInfo.setInvType(pjZzspFpmx.getFplxdm());
                taxDataUploadTranInfo.setInvStatus(InvoiceLoanUtil.fpzt(pjZzspFpmx.getFpzt()));
                taxDataUploadTranInfo.setInvCode(pjZzspFpmx.getFphm());
                taxDataUploadTranInfo.setInvNo(pjZzspFpmx.getFpdm());
                taxDataUploadTranInfo.setTaxAmt(String.valueOf(pjZzspFpmx.getSe()));
                taxDataUploadTranInfo.setInvAmt(String.valueOf(pjZzspFpmx.getHjje()));
                taxDataUploadTranInfo.setTranAmt(String.valueOf(pjZzspFpmx.getJshj()));
                taxDataUploadTranInfo.setOriInvCode(StringHelper.getObjectValue(pjZzspFpmx.getYfpdm()));
                taxDataUploadTranInfo.setOriInvNo(StringHelper.getObjectValue(pjZzspFpmx.getYfphm()));
                taxDataUploadTranInfo.setNotifyNo(StringHelper.getObjectValue(pjZzspFpmx.getTzdh()));
                taxDataUploadTranInfo.setInvDate(pjZzspFpmx.getKprq().substring(0, 8));
                taxDataUploadTranInfo.setInvalDate(StringHelper.subObjectValue(pjZzspFpmx.getZfrq()));
                taxDataUploadTranInfo.setCustName(StringHelper.getObjectValue(pjZzspFpmx.getGhdwmc()));
                taxDataUploadTranInfo.setCustId(StringHelper.getObjectValue(pjZzspFpmx.getGhdwdm()));
                taxDataUploadTranInfos.add(taxDataUploadTranInfo);
            }
        }
        return pjZzspFpmxList;
    }

    public PjZzspFpmx getPjZzspFpmx(String nsrsbh, String sksbbh, String fplxdm) {
        PjZzspFpmx pjZzspFpmx = pjZzspFpmxMapper.getPjZzspFpmx(nsrsbh, sksbbh, fplxdm);
        return pjZzspFpmx;
    }

}