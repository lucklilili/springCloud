package com.bwcloud.finance.center.biz;

import com.alibaba.fastjson.JSONObject;
import com.bwcloud.finance.center.entity.LoanMerchantInfo;
import com.bwcloud.finance.center.mapper.LoanMerchantMapper;
import com.github.wxiaoqi.security.common.biz.BusinessBiz;
import com.github.wxiaoqi.security.common.msg.ResultModel;
import com.github.wxiaoqi.security.common.util.StringHelper;
import com.github.wxiaoqi.security.common.util.UUIDUtils;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * @author dz
 * @version 2018-03-22 11:39:56
 * @email 463540703@qq.com
 */
@Service
@Slf4j
public class LoanMerchantBiz extends BusinessBiz<LoanMerchantMapper, LoanMerchantInfo> {
    @Autowired
    LoanMerchantMapper loanMerchantMapper;

    public ResultModel insertMerchantInfo(String agreementInfo) {
        ResultModel<JSONObject> resultModel = new ResultModel<>();
        JSONObject invoiceJson = JSONObject.parseObject(agreementInfo);
        String nsrsbh = (String) invoiceJson.get("nsrsbh");
        String merchantid = (String) invoiceJson.get("merchantid");
        String xysqbz = (String) invoiceJson.get("xysqbz");
        LoanMerchantInfo loanMerchantInfo = loanMerchantMapper.selectMerchantAgreement(nsrsbh, merchantid);
        try {
            if (StringHelper.isEmpty(loanMerchantInfo)) {
                loanMerchantInfo = new LoanMerchantInfo();
                loanMerchantInfo.setNsrsbh(nsrsbh);
                loanMerchantInfo.setNsrmc((String) invoiceJson.get("nsrmc"));
                loanMerchantInfo.setMerchantid(merchantid);
                loanMerchantInfo.setXfdz(invoiceJson.getString("xfdz"));
                loanMerchantInfo.setXysqbz(xysqbz);
                loanMerchantInfo.setId(UUIDUtils.generateUuid());
                super.insertSelective(loanMerchantInfo);
            } else {
                loanMerchantInfo.setXysqbz(xysqbz);
                super.updateById(loanMerchantInfo);
            }
        } catch (Exception e) {
            log.info("商户协议授权失败:" + e);
            resultModel.setCode(99999);
            resultModel.setMsg("商户协议授权失败:" + e.getMessage());
        }
        return resultModel;
    }

    public ResultModel merchantAgreementInfo(String agreementInfo) {
        JSONObject invoiceJson = JSONObject.parseObject(agreementInfo);
        ResultModel<JSONObject> resultModel = new ResultModel<>();
        try {
            String nsrsbh = (String) invoiceJson.get("nsrsbh");
            String merchantid = invoiceJson.getString("merchantid");
            LoanMerchantInfo loanMerchantInfo = loanMerchantMapper.selectMerchantAgreement(nsrsbh, merchantid);
            JSONObject data = new JSONObject();
            if (StringHelper.isEmpty(loanMerchantInfo)) {
                data.put("xysqbz", "N");
            } else {
                data.put("xysqbz", loanMerchantInfo.getXysqbz());
            }
            resultModel.setData(data);
        } catch (Exception e) {
            resultModel.setCode(9999);
            resultModel.setMsg("服务器异常:" + e);
            log.info("--商户授权查询失败！！！--" + e);
        }
        return resultModel;
    }

    public JSONObject queryInvoiceUploadDate(String merchantInfo) {
        JSONObject merchantJson = JSONObject.parseObject(merchantInfo);
        JSONObject jsonMsg = new JSONObject();
        try {
            String nsrsbh = (String) merchantJson.get("nsrsbh");
            String merchantid = merchantJson.getString("merchantid");
            LoanMerchantInfo loanMerchantInfo = loanMerchantMapper.selectMerchantAgreement(nsrsbh, merchantid);
            if (loanMerchantInfo == null) {
                jsonMsg.put("code", "10013");
                jsonMsg.put("msg", "发票上传日期查询失败，无此商户信息!");
            } else {
                jsonMsg.put("code", "0");
                jsonMsg.put("msg", "发票上传日期查询成功");
                JSONObject data = new JSONObject();
                data.put("fpsc_jzrq", loanMerchantInfo.getFpsc_jzrq());
                jsonMsg.put("data", data);
            }
        } catch (Exception e) {
            jsonMsg.put("code", "10014");
            jsonMsg.put("msg", "发票上传日期失败,服务器异常");
            log.info("--商户授权查询失败！！！--" + e);
        }
        return jsonMsg;
    }

    public List queryMerchantList(String merchantinfo) {
        JSONObject merchantJson = JSONObject.parseObject(merchantinfo);
        return loanMerchantMapper.selectMerchantList((String) merchantJson.get("nsrsbh"), (String) merchantJson.get("merchantid"));
    }
}