package com.bwcloud.finance.center.utils;

import com.alibaba.druid.support.json.JSONUtils;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.bwcloud.finance.center.entity.TaxDataDetailUploadReq;
import com.bwcloud.finance.center.entity.TaxDataUploadRequest;
import com.bwcloud.finance.center.entity.TaxInvoice;
import com.bwcloud.finance.center.entity.TaxInvoiceDetail;
import com.github.wxiaoqi.security.common.util.DateUtils;
import com.github.wxiaoqi.security.common.util.MD5Util;
import com.github.wxiaoqi.security.common.util.UUIDUtils;

import java.io.UnsupportedEncodingException;
import java.math.BigDecimal;
import java.security.NoSuchAlgorithmException;
import java.util.*;

/**
 * @author dz
 *         Created by Administrator on 2018/3/27.
 */
public class InvoiceLoanUtil {

    public static String resultJson(String ver, String req, String signKey,
                                    TaxDataDetailUploadReq taxDataDetailUploadReq) throws UnsupportedEncodingException, NoSuchAlgorithmException {
        TaxDataUploadRequest<TaxDataDetailUploadReq> taxDataUploadRequest = new TaxDataUploadRequest<>();
        String ts = DateUtils.formatSfmStamp(new Date());
        taxDataUploadRequest.setVer(ver);
        taxDataUploadRequest.setReq(req);
        taxDataUploadRequest.setTs(ts);
        taxDataUploadRequest.setMsg(taxDataDetailUploadReq);
        StringBuffer md5Buffer = new StringBuffer();
        md5Buffer.append(MD5Util.HongHaoSignMd5(JSON.toJSONString(taxDataUploadRequest)));
        md5Buffer.append(MD5Util.HongHaoSignMd5(signKey));
        String sign = MD5Util.HongHaoSignMd5(md5Buffer.toString());
        taxDataUploadRequest.setSign(sign);
        return JSON.toJSONString(taxDataUploadRequest);
    }

    public static String fpzt(String fpzt) {
        String invStatus = "";
        if ("00".equals(fpzt)) {
            invStatus = "0";
        } else if ("01".equals(fpzt)) {
            invStatus = "1";
        } else if ("02".equals(fpzt)) {
            invStatus = "2";
        } else if ("03".equals(fpzt)) {
            invStatus = "3";
        } else if ("04".equals(fpzt)) {
            invStatus = "4";
        }

        return invStatus;
    }


    public static Map mapToInvoiceModel(Map invoiceMap) {
        Map map = new HashMap(16);
        TaxInvoice taxInvoice = new TaxInvoice();
        String mid = UUIDUtils.generateUuid();
        taxInvoice.setId(mid);
        taxInvoice.setFplxdm((String) invoiceMap.get("fplxdm"));
        taxInvoice.setFpdm((String) invoiceMap.get("fpdm"));
        taxInvoice.setFphm((String) invoiceMap.get("fphm"));
        taxInvoice.setTspz((String) invoiceMap.get("tspz"));
        taxInvoice.setKprq((String) invoiceMap.get("kprq"));
        taxInvoice.setJqbh((String) invoiceMap.get("jqbh"));
        taxInvoice.setSkm((String) invoiceMap.get("skm"));
        taxInvoice.setGhdwmc((String) invoiceMap.get("ghdwmc"));
        taxInvoice.setGhdwdm((String) invoiceMap.get("ghdwdm"));
        taxInvoice.setGhdwdzdh((String) invoiceMap.get("ghdwdzdh"));
        taxInvoice.setGhdwyhzh((String) invoiceMap.get("ghdwyhzh"));
        taxInvoice.setXhdwmc((String) invoiceMap.get("xhdwmc"));
        taxInvoice.setXhdwdm((String) invoiceMap.get("xhdwdm"));
        taxInvoice.setXhdwdzdh((String) invoiceMap.get("xhdwdzdh"));
        taxInvoice.setXhdwyhzh((String) invoiceMap.get("xhdwyhzh"));
        taxInvoice.setSwjgdm((String) invoiceMap.get("swjgdm"));
        taxInvoice.setSwjgmc((String) invoiceMap.get("swjgmc"));
        taxInvoice.setSpsm((String) invoiceMap.get("spsm"));
        taxInvoice.setZhsl((BigDecimal) invoiceMap.get("zhsl"));
        taxInvoice.setHjje((BigDecimal) invoiceMap.get("hjje"));
        taxInvoice.setSe((BigDecimal) invoiceMap.get("se"));
        taxInvoice.setJshj((BigDecimal) invoiceMap.get("jshj"));
        taxInvoice.setBz((String) invoiceMap.get("bz"));
        taxInvoice.setSkr((String) invoiceMap.get("skr"));
        taxInvoice.setFhr((String) invoiceMap.get("fhr"));
        taxInvoice.setKpr((String) invoiceMap.get("kpr"));
        taxInvoice.setTzdh((String) invoiceMap.get("tzdh"));
        taxInvoice.setKpjh((String) invoiceMap.get("kpjh"));
        taxInvoice.setFpzt((String) invoiceMap.get("fpzt"));
        taxInvoice.setQdbz((String) invoiceMap.get("qdbz"));
        taxInvoice.setZkbz((String) invoiceMap.get("zkbz"));
        taxInvoice.setHjzkje((BigDecimal) invoiceMap.get("hjzkje"));
        taxInvoice.setHjzkse((BigDecimal) invoiceMap.get("hjzkse"));
        taxInvoice.setSsyf((String) invoiceMap.get("ssyf"));
        taxInvoice.setZfrq((String) invoiceMap.get("zfrq"));
        taxInvoice.setZfdqsj((String) invoiceMap.get("zfdqsj"));
        taxInvoice.setZfr((String) invoiceMap.get("zfr"));
        taxInvoice.setZfyy((String) invoiceMap.get("zfyy"));
        taxInvoice.setYfpdm((String) invoiceMap.get("yfpdm"));
        taxInvoice.setYfphm((String) invoiceMap.get("yfphm"));
        taxInvoice.setBbh((String) invoiceMap.get("bbh"));
        taxInvoice.setJym((String) invoiceMap.get("jym"));
        taxInvoice.setCzydm((String) invoiceMap.get("czydm"));
        taxInvoice.setZfrdm((String) invoiceMap.get("zfrdm"));
        taxInvoice.setKpddm((String) invoiceMap.get("kpddm"));
        taxInvoice.setFpcbh((BigDecimal) invoiceMap.get("fpcbh"));
        taxInvoice.setQmcs((String) invoiceMap.get("qmcs"));
        taxInvoice.setQmbz((String) invoiceMap.get("qmbz"));
        taxInvoice.setQmz((String) invoiceMap.get("qmz"));
        taxInvoice.setScbz((String) invoiceMap.get("scbz"));
        taxInvoice.setYqbz((String) invoiceMap.get("yqbz"));
        taxInvoice.setHzxxb((String) invoiceMap.get("hzxxb"));
        taxInvoice.setFpqqlsh((String) invoiceMap.get("fpqqlsh"));
        taxInvoice.setBmbbbh((String) invoiceMap.get("bmbbbh"));
        taxInvoice.setHsslbs((String) invoiceMap.get("hsslbs"));
        taxInvoice.setZsfs((String) invoiceMap.get("zsfs"));
        taxInvoice.setKce((String) invoiceMap.get("kce"));
        taxInvoice.setDybz((String) invoiceMap.get("dybz"));
        List<TaxInvoiceDetail> taxInvoiceDetailList = new ArrayList<>();
        Object obj;
        if ("1".equals(invoiceMap.get("qdbz"))) {
            obj = ((Map) invoiceMap.get("qdxm")).get("group");
        } else {
            obj = ((Map) invoiceMap.get("fyxm")).get("group");
        }
        List<Map> invoiceDetailList = new ArrayList<>();
        if (obj instanceof List) {
            invoiceDetailList.addAll((List<Map>) obj);
        } else {
            invoiceDetailList.add((Map) obj);
        }
        for (int j = 0; j < invoiceDetailList.size(); j++) {
            Map invoiceDetailInfo = invoiceDetailList.get(j);
            TaxInvoiceDetail taxInvoiceDetail = new TaxInvoiceDetail();
            taxInvoiceDetail.setId(UUIDUtils.generateUuid());
            taxInvoiceDetail.setMxid(mid);
            taxInvoiceDetail.setFpdm((String) invoiceMap.get("fpdm"));
            taxInvoiceDetail.setFphm((String) invoiceMap.get("fphm"));
            taxInvoiceDetail.setXsdjbh((String) invoiceDetailInfo.get("xsdjbh"));
            taxInvoiceDetail.setFpmxxh((BigDecimal) invoiceDetailInfo.get("fpmxxh"));
            taxInvoiceDetail.setFphxz((String) invoiceDetailInfo.get("fphxz"));
            taxInvoiceDetail.setJe((BigDecimal) invoiceDetailInfo.get("je"));
            taxInvoiceDetail.setSl((BigDecimal) invoiceDetailInfo.get("sl"));
            taxInvoiceDetail.setSe((BigDecimal) invoiceDetailInfo.get("se"));
            taxInvoiceDetail.setSpmc((String) invoiceDetailInfo.get("spmc"));
            taxInvoiceDetail.setSpsm((String) invoiceDetailInfo.get("spsm"));
            taxInvoiceDetail.setGgxh((String) invoiceDetailInfo.get("ggxh"));
            taxInvoiceDetail.setSpsl((BigDecimal) invoiceDetailInfo.get("spsl"));
            taxInvoiceDetail.setSpdj((BigDecimal) invoiceDetailInfo.get("spdj"));
            taxInvoiceDetail.setDw((String) invoiceDetailInfo.get("dw"));
            taxInvoiceDetail.setHsbz((String) invoiceDetailInfo.get("hsbz"));
            taxInvoiceDetail.setSpbm((String) invoiceDetailInfo.get("spbm"));
            taxInvoiceDetail.setZxbm((String) invoiceDetailInfo.get("zxbm"));
            taxInvoiceDetail.setDjmxxh((String) invoiceDetailInfo.get("djmxxh"));
            taxInvoiceDetail.setYhzcbs((String) invoiceDetailInfo.get("yhzcbs"));
            taxInvoiceDetail.setLslbs((String) invoiceDetailInfo.get("lslbs"));
            taxInvoiceDetail.setZzstsgl((String) invoiceDetailInfo.get("zzstsgl"));
            taxInvoiceDetail.setBb((String) invoiceDetailInfo.get("bb"));
            taxInvoiceDetailList.add(taxInvoiceDetail);
        }
        map.put("invoice", taxInvoice);
        map.put("invoiceDetail", taxInvoiceDetailList);
        return map;
    }
}
